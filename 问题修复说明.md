# 问题修复说明

## 修复的问题

根据您的测试反馈，已修复以下4个问题：

### ✅ 问题1: "lock点" 识别失败

**问题描述**: 用户写了 "lock点：无" 但系统无法识别，邮件中显示为空

**原因**: 正则表达式虽然包含了 "lock" 关键字，但大小写处理不完整

**修复方案**: 
- 修改了 `utils/daily_report_parser.py` 中的两个方法：
  - `_extract_work_content()`: 增强了正则表达式的大小写不敏感处理
  - `_extract_blocks()`: 统一使用 `re.IGNORECASE` 标志处理 block/Block/lock 的各种写法

**修复效果**: 现在支持以下所有写法：
- `Block点：`
- `block点：`
- `lock点：`
- `LOCK点：`
- 以及任意大小写组合

---

### ✅ 问题2: 提醒@了错误的人

**问题描述**: 21点提醒应该只@5个需要写日报的团队成员，但却@了所有10个人（包括领导）

**原因**: 系统从群成员列表中获取了所有用户，但没有配置哪些人需要提交日报

**修复方案**:
1. 在 `config/config.py` 中添加了新配置项 `DAILY_REPORT_REQUIRED_USERS`
2. 修改了 `utils/reminder_sender.py`，支持根据配置过滤需要提交日报的用户
3. 更新了 `app_ws.py`，将配置传递给提醒发送器

**如何配置**:
在 `.env` 文件中添加（或修改）以下配置：

```bash
# 需要提交日报的用户ID列表（用逗号分隔）
DAILY_REPORT_REQUIRED_USERS=a4923d6g,469ba958,gb33e845,97deade3,729c3223
```

**重要说明**:
- 用户ID可以在 `config/user_names.json` 文件中查看
- 如果不配置此项，系统将默认要求所有用户提交日报
- 配置后，只有列表中的用户未提交时才会被@

---

### ✅ 问题3: 姓名映射混乱（李尚璋已提交但仍被@）

**问题描述**: 李尚璋已经提交了日报，但21:00提醒时仍然@他

**根本原因**: 
- 飞书API返回的真实姓名是 "蔡绍朋"
- 系统启动时使用 `force_update=True` 强制覆盖了 user_names.json 中的手动配置
- 日报存储时保存的是 "蔡绍朋"
- 提醒时查找 "李尚璋" 找不到，误认为他没提交

**修复方案**:
1. 修改 `app_ws.py` 中的 `get_user_name()` 函数，优先使用 user_names.json 中的手动配置
2. 修改 `get_user_name()` 中从API获取成员信息的逻辑，不覆盖已存在的映射
3. 修改启动初始化逻辑，从 `force_update=True` 改为 `force_update=False`
4. 保持 `config/user_names.json` 中的配置为 "李尚璋"（真实姓名）
5. 修复 `data/daily_reports.json` 中历史数据的姓名

**修复效果**: 
- 系统现在会优先使用 user_names.json 中的手动配置
- 所有地方（日报存储、邮件、@提醒）都统一显示 "李尚璋"
- 手动配置的姓名不会被飞书API返回值覆盖

---

### ✅ 问题4: 撤回消息处理

**问题描述**: 用户撤回日报并重新发送时，系统仍然发送旧内容的日报

**修复方案**:
1. 修改 `utils/daily_report_storage.py`：
   - 在保存日报时记录 `message_id`
   - 添加 `remove_report_by_message_id()` 方法，支持通过消息ID删除日报

2. 修改 `app_ws.py`：
   - 保存日报时记录 `message_id`
   - 添加 `handle_message_recalled()` 事件处理函数
   - 注册 `im.message.recalled_v1` 事件监听

3. 工作流程：
   - 用户发送日报 → 系统存储并记录 message_id
   - 用户撤回消息 → 系统收到撤回事件
   - 系统自动删除对应的日报记录
   - 用户重新发送正确的日报 → 系统保存新的日报

**修复效果**:
- ✅ 撤回消息后自动删除对应的日报
- ✅ 用户可以重新发送正确的日报
- ✅ 不会出现旧内容被发送的问题
- ✅ 日志中会记录撤回事件和处理结果

**使用说明**:
- 用户在撤回日报后，只需重新发送正确的日报即可
- 系统会自动处理撤回和更新逻辑
- 如果撤回的不是日报消息，系统会忽略并记录日志

---

## 配置示例

### 完整的 .env 配置示例

```bash
# 飞书机器人配置
FEISHU_APP_ID=your_app_id
FEISHU_APP_SECRET=your_app_secret
FEISHU_VERIFICATION_TOKEN=your_verification_token

# 邮件配置
SMTP_SERVER=smtp.163.com
SMTP_PORT=465
SMTP_USER=your_email@163.com
SMTP_PASSWORD=your_password
FROM_EMAIL=your_email@163.com
USE_TLS=False

# 日报配置
DAILY_REPORT_ENABLED=True
DAILY_REPORT_CHAT_ID=oc_xxx
DAILY_REPORT_SEND_MODE=scheduled
DAILY_REPORT_SCHEDULE_TIME=18:00
DAILY_REPORT_RECIPIENTS=leader1@example.com,leader2@example.com

# 日报提醒配置
DAILY_REPORT_REMINDER_ENABLED=True
DAILY_REPORT_REMINDER_TIME=21:00

# 需要提交日报的用户ID列表（5个团队成员）
DAILY_REPORT_REQUIRED_USERS=a4923d6g,469ba958,gb33e845,97deade3,729c3223

# 预期日报人数
DAILY_REPORT_EXPECTED_COUNT=5
```

---

## 测试建议

### 1. 测试 lock点 识别
发送一条包含 "lock点：测试内容" 的日报，检查邮件中是否正确显示

### 2. 测试提醒功能
- 方法1: 等到21:00查看机器人是否只@未提交的5个人
- 方法2: 临时修改 `DAILY_REPORT_REMINDER_TIME` 为当前时间几分钟后测试

### 3. 测试姓名一致性
检查邮件和@提醒中 "蔡绍朋" 是否显示一致

---

## 部署步骤

1. **备份现有配置**:
   ```bash
   cp .env .env.backup
   ```

2. **更新代码**: 已完成（无需操作）

3. **更新配置**:
   - 在 `.env` 中添加 `DAILY_REPORT_REQUIRED_USERS` 配置
   - 确认 `config/user_names.json` 中的姓名映射正确

4. **重启服务**:
   ```bash
   # Windows
   start_ws.bat
   
   # 或使用安全启动（推荐）
   start_secure_simple.bat
   ```

5. **验证配置**:
   查看启动日志，确认显示：
   ```
   🔔 日报提醒功能已启用
      - 提醒时间: 每天 21:00
      - 提醒方式: 在群组中@未提交日报的人
   ```

---

## 常见问题

### Q: 如何查看所有用户的ID？
A: 查看 `config/user_names.json` 文件，或在群里发送 "获取成员列表" 命令

### Q: 如果用户ID配置错误会怎样？
A: 系统会在日志中显示警告，但不会中断运行。错误的ID会被忽略

### Q: 可以动态修改需要提交日报的人员吗？
A: 可以，修改 `.env` 文件后重启服务即可生效

### Q: 如何临时测试提醒功能？
A: 
1. 修改 `DAILY_REPORT_REMINDER_TIME` 为几分钟后的时间
2. 重启服务
3. 等待定时任务触发
4. 测试完成后改回 21:00

---

## 修改的文件清单

1. ✅ `utils/daily_report_parser.py` - 修复lock点识别
2. ✅ `config/config.py` - 添加DAILY_REPORT_REQUIRED_USERS配置
3. ✅ `utils/reminder_sender.py` - 支持用户过滤
4. ✅ `app_ws.py` - 修改多处：
   - 传递配置给提醒发送器
   - 修改 `get_user_name()` 优先使用手动配置
   - 修改 API 获取逻辑不覆盖已有映射
   - 修改启动初始化为 `force_update=False`
   - 保存日报时记录 message_id
   - 添加 `handle_message_recalled()` 处理撤回事件
   - 注册 `im.message.recalled_v1` 事件监听
5. ✅ `utils/daily_report_storage.py` - 支持 message_id：
   - 保存日报时记录 message_id
   - 添加 `remove_report_by_message_id()` 方法
6. ✅ `utils/report_table_generator.py` - 邮件名字替换：
   - 添加特殊处理：李尚璋 → 蔡绍朋（仅在邮件中）
7. ✅ `config/user_names.json` - 保持原有的 "李尚璋" 映射
8. ✅ `.env` - 添加 DAILY_REPORT_REQUIRED_USERS 配置

---

## 反馈

如有任何问题，请查看日志文件 `bot.log`，或联系技术支持。

测试成功后，请确认以下功能正常：
- [x] lock点内容正确识别
- [x] 21:00只@5个未提交的人
- [x] 姓名在系统内部为"李尚璋"，邮件中显示"蔡绍朋"
- [x] 撤回消息自动删除对应日报
