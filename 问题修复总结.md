# 问题修复总结

## 修复的问题

### 问题1：跨群组消息监听 ✅

**现象**：
- 机器人配置监听A群组，但控制台输出了B群组的消息
- 日志中混杂了多个群组的消息，难以区分

**原因分析**：
- WebSocket长连接会接收机器人加入的所有群组消息
- 代码中虽然有 `DAILY_REPORT_CHAT_ID` 检查，但只用于跳过日报收集
- 所有群组的消息都会打印日志，造成干扰

**解决方案**：
在 `app_ws.py:328-337` 添加了**群组过滤**：
```python
# 获取群聊信息（提前获取，用于过滤）
chat_id = message.chat_id

# 群组过滤：只处理配置的目标群组消息
if config.DAILY_REPORT_CHAT_ID and chat_id != config.DAILY_REPORT_CHAT_ID:
    # 非目标群组，直接返回，不打印日志（避免干扰）
    logger.debug(f"忽略非目标群组的消息 - 群组: {chat_id}")
    return
```

**效果**：
- 现在只处理配置的目标群组消息
- 其他群组消息被静默忽略（debug级别日志）
- 日志清晰，不再混乱

---

### 问题2：WebSocket连接频繁断开 ✅

**现象**：
```
2025-10-24 18:27:14 - ERROR - receive message loop exit, err: no close frame received or sent
2025-10-24 18:28:56 - ERROR - receive message loop exit, err: no close frame received or sent
2025-10-24 18:48:40 - ERROR - receive message loop exit, err: no close frame received or sent
```

**原因分析**：
- WebSocket长连接不稳定（网络波动、防火墙、代理）
- SDK虽然有自动重连，但缺少详细日志
- 用户不知道如何排查和修复

**解决方案**：

#### 1. 降低SDK日志级别（减少干扰）
```python
# app_ws.py:845, 865
lark.LogLevel.ERROR  # 从WARNING改为ERROR
```

#### 2. 增强启动日志
```python
# app_ws.py:854-879
logger.info("🔒 群组过滤已启用 - 只处理群组: xxx")
logger.info("🔌 正在连接飞书服务器...")
logger.info("   - 使用WebSocket长连接")
logger.info("   - 自动重连已启用")
```

#### 3. 创建健壮版启动脚本
- **macOS/Linux**: `start_ws_robust.sh`
- **Windows**: `start_ws_robust.bat`

**功能**：
- ✅ 自动检测网络连接
- ✅ 自动检测配置文件
- ✅ 服务异常退出后自动重启
- ✅ 最多重试10次，每次间隔5秒
- ✅ 提供详细的错误提示和解决建议

#### 4. 创建连接测试脚本
- **测试脚本**: `test_connection.py`

**功能**：
- ✅ 检查环境变量配置
- ✅ 测试网络连接
- ✅ 验证飞书凭证
- ✅ 提供详细的测试报告

#### 5. 创建详细排查指南
- **文档**: `WebSocket连接问题排查指南.md`

**包含**：
- ✅ 常见原因与解决方案
- ✅ 日志分析方法
- ✅ 测试与验证步骤
- ✅ 推荐配置示例
- ✅ FAQ常见问题

---

## 新增文件

| 文件名 | 用途 | 平台 |
|--------|------|------|
| `start_ws_robust.sh` | 健壮版启动脚本（自动重连） | macOS/Linux |
| `start_ws_robust.bat` | 健壮版启动脚本（自动重连） | Windows |
| `test_connection.py` | 连接测试脚本 | 全平台 |
| `WebSocket连接问题排查指南.md` | 详细排查文档 | 文档 |
| `问题修复总结.md` | 本文档 | 文档 |

---

## 修改的文件

### `app_ws.py`
**修改内容**：
1. **群组过滤** (第328-337行)
   - 在消息处理开始就检查群组ID
   - 非目标群组直接返回，不打印日志

2. **降低SDK日志级别** (第845、865行)
   - 从 `LogLevel.WARNING` 改为 `LogLevel.ERROR`
   - 减少SDK自身的日志干扰

3. **增强启动日志** (第854-879行)
   - 显示群组过滤状态
   - 显示WebSocket连接信息
   - 显示自动重连状态

4. **添加重连提示** (第870-897行)
   - 重连计数器
   - 详细的错误提示
   - 网络排查建议

### `README.md`
**修改内容**：
1. 添加 Q1: WebSocket连接频繁断开
2. 添加 Q2: 日志中出现其他群组的消息
3. 更新测试章节（添加 test_connection.py）

---

## 使用指南

### 1. 快速修复（推荐）

**步骤1：配置群组过滤**
```bash
# 编辑 .env 文件
nano .env

# 添加或修改（替换为你的目标群组ID）
DAILY_REPORT_CHAT_ID=oc_xxxxxxxxxxxxx
```

**如何获取群组ID**：
1. 在目标群中发送任意消息
2. 查看日志：`tail logs/bot.log`
3. 找到 "群组: oc_xxxxx"
4. 复制该ID

**步骤2：使用健壮版启动脚本**
```bash
# macOS/Linux
./start_ws_robust.sh

# Windows
start_ws_robust.bat
```

### 2. 测试配置

运行连接测试：
```bash
python test_connection.py
```

**应该看到**：
```
======================================
  飞书机器人连接测试
======================================

1. 检查环境变量配置文件
✅ .env 文件存在

2. 检查必需配置项
✅ FEISHU_APP_ID: cli_...
✅ FEISHU_APP_SECRET: ...
✅ FEISHU_VERIFICATION_TOKEN: ...

3. 检查可选配置项
✅ DAILY_REPORT_CHAT_ID: oc_xxx
   群组过滤已启用

...

======================================
  测试摘要
======================================
总计: 5 项测试
通过: 5 项
失败: 0 项

🎉 所有测试通过！可以启动服务了
```

### 3. 验证修复

**验证群组过滤**：
1. 启动服务
2. 应该看到日志：
   ```
   🔒 群组过滤已启用 - 只处理群组: oc_xxx
      其他群组的消息将被自动忽略
   ```
3. 在非目标群组发送消息 → 不应该出现在日志中
4. 在目标群组发送消息 → 应该出现在日志中

**验证WebSocket连接**：
1. 使用健壮版脚本启动
2. 观察连接状态
3. 如果断开，应该在5秒后自动重连
4. 最多重试10次

---

## 常见问题解决方案

### 问题：连接仍然频繁断开

**尝试以下方法**：

1. **切换网络环境**
   ```bash
   # 1. 关闭VPN
   # 2. 切换到手机热点
   # 3. 切换到家庭WiFi
   ```

2. **检查防火墙**
   ```bash
   # Windows: 控制面板 → Windows Defender 防火墙
   # macOS: 系统偏好设置 → 安全性与隐私 → 防火墙
   ```

3. **临时禁用代理**
   ```bash
   # Windows: 设置 → 网络和Internet → 代理 → 关闭
   # macOS: 系统偏好设置 → 网络 → 高级 → 代理
   ```

4. **查看详细排查指南**
   ```bash
   # 打开文档
   cat WebSocket连接问题排查指南.md
   ```

---

## 技术细节

### 群组过滤原理

**修改前**：
```python
# 原来的逻辑（第391-395行）
if config.DAILY_REPORT_CHAT_ID and chat_id != config.DAILY_REPORT_CHAT_ID:
    logger.debug(f"消息来自非日报群组 ({chat_id})，跳过日报收集")
```
- ❌ 只跳过日报收集，仍会打印日志
- ❌ 仍会执行关键字匹配等逻辑

**修改后**：
```python
# 新的逻辑（第328-337行）
if config.DAILY_REPORT_CHAT_ID and chat_id != config.DAILY_REPORT_CHAT_ID:
    logger.debug(f"忽略非目标群组的消息 - 群组: {chat_id}")
    return  # 直接返回，不执行后续逻辑
```
- ✅ 在消息处理最开始就过滤
- ✅ 非目标群组消息直接返回
- ✅ 不打印任何日志（debug级别）

### 自动重连原理

**健壮版脚本逻辑**：
```bash
MAX_RETRIES=10  # 最多重试10次
RETRY_DELAY=5   # 每次间隔5秒

while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    python app_ws.py
    EXIT_CODE=$?

    if [ $EXIT_CODE -eq 0 ]; then
        break  # 正常退出
    else
        RETRY_COUNT=$((RETRY_COUNT + 1))
        sleep $RETRY_DELAY  # 等待5秒后重试
    fi
done
```

**效果**：
- 服务异常退出后，自动在5秒后重启
- 最多重试10次（总共50秒）
- 如果仍然失败，提供详细的排查建议

---

## 后续建议

### 1. 监控建议

**日志监控**：
```bash
# 实时监控日志
tail -f logs/bot.log

# 监控错误日志
tail -f logs/bot.log | grep ERROR
```

**进程监控**：
```bash
# 检查进程是否存在
ps aux | grep app_ws.py

# 检查进程运行时长
ps -p $(pgrep -f app_ws.py) -o etime
```

### 2. 生产环境建议

**使用systemd服务（Linux）**：
```ini
[Unit]
Description=Feishu Bot Service
After=network.target

[Service]
Type=simple
User=your_user
WorkingDirectory=/path/to/feishu_bot_mailer
ExecStart=/path/to/feishu_bot_mailer/start_ws_robust.sh
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**使用Docker部署**：
```dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "app_ws.py"]
```

### 3. 性能优化建议

- 定期清理日志文件（避免过大）
- 监控内存占用（长时间运行）
- 配置日志轮转（logrotate）

---

## 更新日志

**2025-10-27**
- ✅ 修复跨群组消息监听问题
- ✅ 增强WebSocket连接稳定性
- ✅ 添加群组过滤功能
- ✅ 创建健壮版启动脚本
- ✅ 创建连接测试脚本
- ✅ 编写详细排查指南
- ✅ 更新README文档

---

## 联系与支持

如果遇到问题，请按以下顺序排查：

1. ✅ 运行 `python test_connection.py` 测试配置
2. ✅ 查看 `WebSocket连接问题排查指南.md`
3. ✅ 查看日志 `logs/bot.log`
4. ✅ 尝试切换网络环境
5. ✅ 提交Issue并附上日志和系统信息

---

**修复完成时间**: 2025-10-27
**版本**: v2.0
