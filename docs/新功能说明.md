# 日报系统新功能说明

## 功能概述

本次更新添加了4个核心功能，实现了**智能化日报汇总**，确保每天只发送一封汇总邮件给领导。

---

## 1. 即时汇总策略（5人全部提交后立即发送）

### 功能说明
当所有团队成员（包括休假的人）都提交日报后，系统会**立即自动发送汇总邮件**，无需等待到固定时间。

### 工作流程
1. 每收到一份日报后，系统检查当前日报数量
2. 如果达到预期人数（配置为5人），立即发送汇总
3. 休假的人会自动计入已提交（内容显示为"休假"）
4. 发送后标记为已发送，避免重复

### 配置参数
```bash
# .env 文件配置
DAILY_REPORT_EXPECTED_COUNT=5              # 预期日报人数
DAILY_REPORT_AUTO_SEND_ON_COMPLETE=True    # 是否启用即时汇总
```

### 使用示例
```
场景：团队有5个人
- 小明、小红、小刚提交日报 → 系统等待
- 小李设置休假 → 系统自动为小李生成"休假"日报
- 小王提交日报 → 系统检测到5人齐全，立即发送汇总邮件 ✅
```

---

## 2. 第二天10点补充汇总（汇总前一天未提交的人）

### 功能说明
如果当天没有达到5人，第二天10点会自动汇总前一天的所有日报（包括今天早上补交昨天的）。

### 工作流程
1. 每天10点执行定时任务
2. 检查前一天的日报是否已发送
3. 如果未发送，汇总前一天的所有日报（含补交的）
4. 发送邮件并标记为已发送

### 配置参数
```bash
# .env 文件配置
DAILY_REPORT_NEXT_DAY_SUMMARY_ENABLED=True  # 是否启用第二天补充汇总
DAILY_REPORT_NEXT_DAY_SUMMARY_TIME=10:00    # 第二天汇总时间
```

### 使用示例
```
场景：昨天只有3人提交日报

时间线：
- 昨天 18:00：只有3人提交，未达到5人，不发送
- 今天 09:00：小王补交昨天的日报
- 今天 10:00：系统自动汇总昨天的4份日报，发送邮件 ✅
```

---

## 3. 休假管理功能（手动指令设置休假）

### 功能说明
通过飞书群聊命令设置/取消团队成员的休假状态，休假的人会自动生成"休假"日报。

### 使用命令

#### 设置休假
在飞书群中发送以下任一格式：
```
张三#休假
@张三#休假
```

#### 取消休假
```
取消#张三#休假
张三#取消休假
```

### 自动生成休假日报
休假的人无需手动提交日报，系统会自动生成：
- **跟踪问题**: -
- **工作内容**: 休假
- **Block点**: -
- **下一工作日计划**: -

### 使用示例
```
管理员在群中发送：
> 张三#休假

系统响应：
✅ 已设置 张三 休假

当天汇总时：
- 张三的日报内容自动显示为"休假"
- 计入已提交人数，不影响即时汇总
```

---

## 4. 姓名替换功能（李尚璋 → 蔡绍朋）

### 功能说明
系统在获取用户姓名时，会自动将"李尚璋"替换为"蔡绍朋"显示在邮件中。

### 实现位置
- 群成员列表获取
- 日报发送者姓名
- 邮件汇总表格

### 配置方式
此功能已硬编码在 `app_ws.py` 的 `get_user_name()` 函数中：
```python
# 特殊处理：李尚璋 → 蔡绍朋
if name == "李尚璋":
    return "蔡绍朋"
```

---

## 完整配置示例

### .env 配置文件
```bash
# ============================================
# 日报功能基础配置
# ============================================
DAILY_REPORT_ENABLED=True
DAILY_REPORT_CHAT_ID=oc_xxxxxxxxxxxxxx
DAILY_REPORT_RECIPIENTS=manager@example.com

# ============================================
# 即时汇总配置（5人全部提交后立即发送）
# ============================================
DAILY_REPORT_EXPECTED_COUNT=5
DAILY_REPORT_AUTO_SEND_ON_COMPLETE=True

# ============================================
# 第二天补充汇总配置
# ============================================
DAILY_REPORT_NEXT_DAY_SUMMARY_ENABLED=True
DAILY_REPORT_NEXT_DAY_SUMMARY_TIME=10:00

# ============================================
# 休假管理配置
# ============================================
VACATION_STORAGE_FILE=data/vacations.json
```

---

## 核心逻辑流程图

```
收到日报
  ↓
存储到 data/daily_reports.json
  ↓
检查当天是否已发送 ──Yes→ 跳过
  ↓ No
检查休假人员 → 自动生成"休假"日报
  ↓
当前日报数 >= 预期人数(5)？
  ↓ Yes                      ↓ No
立即发送汇总 ✅          等待更多日报
  ↓
标记为已发送              第二天10点 ──检查→ 未发送
                              ↓
                          汇总前一天日报
                              ↓
                          发送邮件 ✅
```

---

## 数据存储格式

### daily_reports.json（新格式）
```json
{
  "2025-10-21": {
    "reports": [
      {
        "sender": "张三",
        "tracking_issues": "TSTAS-431",
        "work_content": "完成功能开发",
        "blocks": "无",
        "next_plan": "测试",
        "timestamp": "2025-10-21 17:30:00",
        "date": "2025-10-21"
      },
      {
        "sender": "李四",
        "tracking_issues": "-",
        "work_content": "休假",
        "blocks": "-",
        "next_plan": "-",
        "timestamp": "2025-10-21 18:00:00",
        "date": "2025-10-21"
      }
    ],
    "sent": true
  }
}
```

### vacations.json
```json
{
  "2025-10-21": ["李四", "王五"],
  "2025-10-22": ["张三"]
}
```

---

## 升级说明

### 兼容性
- ✅ 新代码向后兼容旧的日报存储格式
- ✅ 首次运行时会自动转换旧数据
- ✅ 不影响现有功能

### 需要的新依赖
无需额外安装Python包，使用内置库即可。

### 启动服务
```bash
python3 app_ws.py
```

启动日志会显示：
```
📊 日报功能已启用
⚡ 即时汇总功能已启用
   - 预期人数: 5
   - 说明: 当收到的日报数达到预期人数时，将自动发送汇总邮件
🔄 第二天补充汇总功能已启用
   - 汇总时间: 每天 10:00
   - 说明: 如果前一天未发送汇总，第二天将自动汇总前一天的所有日报
```

---

## 常见问题

### Q1: 如果5人全部提交后还有人修改日报怎么办？
A: 系统已发送后会标记为已发送，不会重复发送。如需重新发送，需要手动处理。

### Q2: 休假的人第二天来上班了怎么办？
A: 发送"取消#姓名#休假"命令即可，系统会移除休假状态。

### Q3: 第二天补充汇总会重复发送吗？
A: 不会。系统会检查前一天是否已发送，如果已发送就跳过。

### Q4: 可以修改预期人数吗？
A: 可以，修改 `.env` 文件中的 `DAILY_REPORT_EXPECTED_COUNT` 参数，重启服务即可。

---

## 联系与支持

如有问题或建议，请联系开发团队。
