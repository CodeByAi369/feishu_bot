# .env 文件加密保护指南

## 🔐 三种保护方法对比

| 方法 | 安全性 | 易用性 | 适用场景 |
|------|--------|--------|---------|
| **Windows EFS** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 个人电脑，单用户 |
| **7-Zip加密** | ⭐⭐⭐⭐ | ⭐⭐⭐ | 需要手动控制 |
| **Python加密** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 生产环境，自动化 |

---

## 方法1：Windows EFS 文件加密（最简单）

### 优点
- ✅ Windows自带，无需额外软件
- ✅ 程序能透明读取，无需解密
- ✅ 其他Windows用户无法访问

### 操作步骤

1. 找到 `.env` 文件
2. **右键 → 属性**
3. 点击 **"高级"** 按钮
4. 勾选 **"加密内容以保护数据"**
5. **确定 → 应用**

### 注意事项

⚠️ **重要：备份加密证书！**

重装系统前必须导出证书：
1. Win+R → `certmgr.msc`
2. 个人 → 证书
3. 找到你的证书 → 右键 → 所有任务 → 导出
4. 按向导导出为 `.pfx` 文件

---

## 方法2：7-Zip 密码加密

### 安装 7-Zip

下载：https://www.7-zip.org/

### 加密 .env 文件

```bash
# 方法1：图形界面
1. 右键 .env 文件
2. 7-Zip → 添加到压缩包
3. 设置密码
4. 勾选"加密文件名"
5. 确定

# 方法2：命令行
7z a -p -mhe=on .env.7z .env
```

### 使用方法

**手动方式：**
```bash
# 解密
7z x .env.7z

# 运行服务
python app_ws.py

# 完成后删除解密文件
del .env
```

**自动方式：**
```bash
# 使用我提供的脚本
decrypt_and_start.bat
```

---

## 方法3：Python加密（推荐）

### 优点
- ✅ 最安全（AES-256加密）
- ✅ 跨平台
- ✅ 密码保护
- ✅ 自动化

### 步骤1：安装加密库

```bash
pip install cryptography
```

### 步骤2：加密 .env 文件

```bash
python encrypt_env.py
```

**操作流程：**
1. 选择 `1` (加密)
2. 输入密码（至少6位）
3. 确认密码
4. 选择是否删除原始 .env 文件

**生成文件：**
- `.env.encrypted` - 加密后的文件（可以安全存储）
- `.env` - 原始文件（建议删除）

### 步骤3：解密并运行

**方法A：自动解密启动（推荐）**
```bash
start_with_encryption.bat
```
- 会自动提示输入密码
- 解密 .env
- 启动服务
- 服务停止后自动删除 .env

**方法B：手动解密**
```bash
python encrypt_env.py
# 选择 2 (解密)
# 输入密码

python app_ws.py
```

### 步骤4：日常使用

```bash
# Windows
start_with_encryption.bat

# 输入密码后即可运行
```

---

## 🔒 安全最佳实践

### 1. 密码管理
- ✅ 使用强密码（至少12位，包含大小写字母、数字、符号）
- ✅ 不要在代码中硬编码密码
- ✅ 使用密码管理器（如1Password、Bitwarden）

### 2. 文件管理
- ✅ 加密后删除原始 `.env` 文件
- ✅ 不要将 `.env` 提交到Git
- ✅ `.gitignore` 中添加：
  ```
  .env
  .env.encrypted
  .env.backup
  ```

### 3. 备份
- ✅ 备份 `.env.encrypted` 文件
- ✅ 使用云盘或加密U盘保存备份
- ✅ 记录密码（使用密码管理器）

### 4. 多环境管理
```
.env.encrypted          # 生产环境
.env.dev.encrypted      # 开发环境
.env.test.encrypted     # 测试环境
```

---

## 📋 常见问题

### Q1: 忘记密码怎么办？
**A:** 无法恢复。这就是加密的意义。建议：
- 使用密码管理器
- 在安全的地方备份密码

### Q2: 可以在Mac和Windows之间共享加密文件吗？
**A:**
- ✅ Python加密：可以
- ❌ Windows EFS：不可以
- ✅ 7-Zip：可以

### Q3: 如何修改 .env 内容？
**A:**
```bash
# 1. 解密
python encrypt_env.py  # 选择2

# 2. 编辑
notepad .env

# 3. 重新加密
python encrypt_env.py  # 选择1

# 4. 删除原文件
del .env
```

### Q4: Git仓库中应该存储什么？
**A:**
```
✅ 应该存储：
- .env.example (模板文件，不含敏感信息)
- encrypt_env.py (加密工具)
- start_with_encryption.bat (启动脚本)

❌ 不应该存储：
- .env (原始配置，含敏感信息)
- .env.encrypted (加密配置，但也别存)
- .env.backup (备份文件)
```

### Q5: 部署到服务器如何处理？
**A:**
```bash
# 1. 在服务器上创建 .env 文件
# 2. 或者上传 .env.encrypted，每次启动时解密
# 3. 或者使用环境变量（推荐）：
export FEISHU_APP_ID=xxx
export FEISHU_APP_SECRET=xxx
```

---

## 🎯 推荐方案

### 个人开发
- Windows EFS（最方便）

### 团队协作
- Python加密 + 密码管理器

### 生产部署
- 环境变量 + 密钥管理服务（AWS Secrets Manager、Azure Key Vault）

---

## 📞 需要帮助？

如果遇到问题：
1. 检查 `logs/bot.log` 日志
2. 确认密码是否正确
3. 检查文件是否存在
4. 确认加密库已安装

---

**记住：安全第一！** 🔐
